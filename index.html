<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل الدخول - ProBot</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #000;
      color: #fff;
      padding: 30px;
      direction: rtl;
    }
    #login-section button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      color: white;
      background: linear-gradient(90deg, #e74c3c, #3498db);
      transition: background 0.3s ease;
    }
    #login-section button:hover {
      background: linear-gradient(90deg, #c0392b, #2980b9);
    }
    #guilds-list {
      margin-top: 30px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      text-align: right;
    }
    #guilds-list ul {
      list-style: none;
      padding: 0;
    }
    #guilds-list li {
      background: #222;
      margin-bottom: 10px;
      padding: 12px 15px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }
    #guilds-list li.selected {
      border-color: #3498db;
      background: #34495e;
    }
    #invite-btn {
      margin-top: 20px;
      padding: 12px 25px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      display: none;
    }
    #invite-btn:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div id="login-section">
    <h1>مرحباً بك في ProBot</h1>
    <a href="https://discord.com/oauth2/authorize?client_id=1360270113001177118&redirect_uri=https%3A%2F%2Ftubular-parfait-58a9e4.netlify.app%2F&response_type=token&scope=identify%20guilds">
      <button>تسجيل الدخول عبر ديسكورد</button>
    </a>
  </div>

  <div id="app-section" class="hidden">
    <h2>اختر سيرفرك</h2>
    <div id="guilds-list">
      <ul id="guilds-ul"></ul>
    </div>
    <button id="invite-btn">إدخال البوت</button>
  </div>

  <script>
    const clientId = "1360270113001177118";
    const redirectUri = "https://tubular-parfait-58a9e4.netlify.app/";
    let selectedGuildId = null;

    async function fetchDiscordData(token) {
      const guildsRes = await fetch('https://discord.com/api/users/@me/guilds', {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!guildsRes.ok) {
        alert('فشل في جلب بيانات السيرفرات.');
        return;
      }
      const guilds = await guildsRes.json();

      const adminGuilds = guilds.filter(guild => (guild.permissions & 0x8) === 0x8);

      if (adminGuilds.length === 0) {
        alert("لا يوجد لديك سيرفرات بصلاحية إدارة.");
        return;
      }

      document.getElementById("login-section").classList.add("hidden");
      document.getElementById("app-section").classList.remove("hidden");

      const ul = document.getElementById("guilds-ul");
      ul.innerHTML = "";

      adminGuilds.forEach(guild => {
        const li = document.createElement("li");
        li.textContent = guild.name;
        li.dataset.guildId = guild.id;
        li.addEventListener("click", () => {
          document.querySelectorAll("#guilds-ul li").forEach(el => el.classList.remove("selected"));
          li.classList.add("selected");
          selectedGuildId = guild.id;
          document.getElementById("invite-btn").style.display = "inline-block";
        });
        ul.appendChild(li);
      });
    }

    document.getElementById("invite-btn").addEventListener("click", () => {
      if (!selectedGuildId) return;
      const inviteUrl = `https://discord.com/oauth2/authorize?client_id=${clientId}&permissions=8&scope=bot%20applications.commands&guild_id=${selectedGuildId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code`;
      window.open(inviteUrl, "_blank");
    });

    const hash = window.location.hash;
    if (hash && hash.includes("access_token")) {
      const params = new URLSearchParams(hash.substring(1));
      const token = params.get("access_token");
      fetchDiscordData(token);
    }
  </script>
</body>
</html>
